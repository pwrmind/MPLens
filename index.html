<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PriceMaster - Система сравнения цен</title>
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        .price-increase {
            color: #ef4444;
        }
        .price-decrease {
            color: #22c55e;
        }
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        
        .dark .price-increase {
            color: #f87171;
        }
        .dark .price-decrease {
            color: #4ade80;
        }
        
        .theme-toggle {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 30px;
        }
        
        .theme-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .theme-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #4b5563;
            transition: .4s;
            border-radius: 34px;
        }
        
        .theme-slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .theme-slider {
            background-color: #2563eb;
        }
        
        input:checked + .theme-slider:before {
            transform: translateX(30px);
        }
        
        .theme-slider i {
            position: absolute;
            top: 6px;
            font-size: 18px;
        }
        
        .fa-sun {
            left: 6px;
            color: #f59e0b;
        }
        
        .fa-moon {
            right: 6px;
            color: #e5e7eb;
        }
        
        .dark {
            color: #e5e7eb;
            background-color: #111827;
        }
        
        .dark .bg-white {
            background-color: #1f2937;
        }
        
        .dark .border-gray-200 {
            border-color: #374151;
        }
        
        .dark .text-gray-500 {
            color: #9ca3af;
        }
        
        .dark .text-gray-900 {
            color: #f3f4f6;
        }
        
        .dark .bg-gray-50 {
            background-color: #1f2937;
        }
        
        .dark .bg-indigo-50 {
            background-color: #1e3a8a;
        }
        
        .dark .bg-indigo-600 {
            background-color: #3b82f6;
        }
        
        .dark .hover\:bg-indigo-700:hover {
            background-color: #2563eb;
        }
        
        .dark .bg-red-100 {
            background-color: #7f1d1d;
        }
        
        .dark .bg-green-100 {
            background-color: #14532d;
        }
        
        .dark .text-red-800 {
            color: #fecaca;
        }
        
        .dark .text-green-800 {
            color: #bbf7d0;
        }
        
        .competitor-badge {
            background-color: #fde68a;
            color: #92400e;
        }
        
        .dark .competitor-badge {
            background-color: #92400e;
            color: #fde68a;
        }
        
        .manager-badge {
            background-color: #dbeafe;
            color: #1e40af;
        }
        
        .dark .manager-badge {
            background-color: #1e40af;
            color: #dbeafe;
        }
        
        .store-card {
            transition: all 0.3s ease;
            border-left: 4px solid #4f46e5;
        }
        
        .store-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        
        .dark .store-card {
            border-left: 4px solid #818cf8;
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 transition-colors duration-300">
    <div id="app" class="flex flex-col min-h-screen dark:bg-gray-900">
        <!-- Шапка -->
        <header class="bg-white dark:bg-gray-800 shadow py-4 px-6">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-4">
                    <h1 class="text-2xl font-bold text-indigo-700 dark:text-indigo-400 flex items-center">
                        <i class="fas fa-chart-line mr-2"></i>PriceMaster
                    </h1>
                    
                    <!-- Выбор магазина -->
                    <div class="relative" v-if="currentUser">
                        <select v-model="currentStoreId" @change="changeStore" class="pl-10 pr-8 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white appearance-none">
                            <option v-for="store in currentUser.stores" :key="store.id" :value="store.id">
                                {{ store.name }} ({{ store.managers.length }} менеджеров)
                            </option>
                        </select>
                        <i class="fas fa-store absolute left-3 top-3 text-gray-400 dark:text-gray-300"></i>
                        <i class="fas fa-chevron-down absolute right-3 top-3 text-gray-400 dark:text-gray-300"></i>
                    </div>
                </div>
                
                <div class="flex items-center space-x-4">
                    <div class="flex items-center space-x-3">
                        <i class="fas fa-sun text-yellow-400"></i>
                        <label class="theme-toggle">
                            <input type="checkbox" v-model="darkMode" @change="toggleTheme">
                            <span class="theme-slider">
                                <i class="fas fa-sun"></i>
                                <i class="fas fa-moon"></i>
                            </span>
                        </label>
                        <i class="fas fa-moon text-blue-300"></i>
                    </div>
                    
                    <!-- Профиль пользователя -->
                    <div class="relative group" v-if="currentUser">
                        <button class="flex items-center space-x-2 focus:outline-none">
                            <div class="w-10 h-10 rounded-full bg-indigo-100 dark:bg-indigo-900 flex items-center justify-center">
                                <i class="fas fa-user text-indigo-600 dark:text-indigo-300"></i>
                            </div>
                            <div class="text-left hidden md:block">
                                <div class="font-medium dark:text-gray-200">{{ currentUser.name }}</div>
                                <div class="text-xs text-gray-500 dark:text-gray-400">{{ currentUser.email }}</div>
                            </div>
                        </button>
                        
                        <!-- Выпадающее меню -->
                        <div class="absolute right-0 mt-2 w-48 bg-white dark:bg-gray-800 rounded-lg shadow-lg py-1 z-50 hidden group-hover:block">
                            <a href="#" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
                                <i class="fas fa-cog mr-2"></i> Настройки
                            </a>
                            <a href="#" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
                                <i class="fas fa-sign-out-alt mr-2"></i> Выйти
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Основной контент -->
        <main class="flex flex-1 overflow-hidden">
            <!-- Боковая панель - Менеджеры и их SKU -->
            <div class="w-1/4 bg-white dark:bg-gray-800 border-r border-gray-200 dark:border-gray-700 flex flex-col">
                <div class="p-4 border-b border-gray-200 dark:border-gray-700">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-semibold dark:text-gray-200">
                            <i class="fas fa-users mr-2"></i>Менеджеры магазина
                        </h2>
                        <button @click="showAddManagerModal = true" class="text-indigo-600 hover:text-indigo-800 dark:text-indigo-400 dark:hover:text-indigo-300">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    
                    <div class="mb-4">
                        <select v-model="currentManagerId" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                            <option v-for="manager in currentStore.managers" :key="manager.id" :value="manager.id">
                                {{ manager.name }} ({{ manager.skus.length }} SKU)
                            </option>
                        </select>
                    </div>
                    
                    <div class="flex mb-4">
                        <input v-model="newSku" type="text" placeholder="Добавить SKU для менеджера..." 
                               class="flex-1 px-4 py-2 border border-gray-300 rounded-l-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                        <button @click="addNewManagerSku" 
                                class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-r-lg dark:bg-indigo-700 dark:hover:bg-indigo-600">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                </div>
                
                <div class="overflow-y-auto flex-1 scrollbar-hide">
                    <div v-if="currentManager" class="p-3 bg-indigo-50 dark:bg-indigo-900 text-indigo-800 dark:text-indigo-200 font-medium">
                        <i class="fas fa-user-tie mr-2"></i> {{ currentManager.name }}
                    </div>
                    
                    <div v-for="(sku, index) in currentManagerSkus" :key="index" 
                         @click="selectManagerSku(sku)"
                         :class="{'bg-indigo-50 dark:bg-indigo-900 border-l-4 border-indigo-500 dark:border-indigo-400': selectedManagerSku && selectedManagerSku.id === sku.id}"
                         class="p-3 border-b border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer flex justify-between items-center">
                        <div>
                            <div class="font-medium dark:text-gray-200">{{ sku.name }}</div>
                            <div class="text-sm text-gray-500 dark:text-gray-400">ID: {{ sku.id }}</div>
                        </div>
                        <div class="flex space-x-2">
                            <span class="text-xs px-2 py-1 rounded-full" 
                                  :class="sku.priceChange >= 0 ? 'bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200' : 'bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200'">
                                {{ sku.priceChange >= 0 ? '↑' : '↓' }} {{ Math.abs(sku.priceChange) }}%
                            </span>
                        </div>
                    </div>
                    
                    <div v-if="currentManagerSkus.length === 0" class="p-6 text-center text-gray-500 dark:text-gray-400">
                        <i class="fas fa-inbox text-3xl mb-2"></i>
                        <p>Нет SKU для этого менеджера</p>
                    </div>
                </div>
            </div>

            <!-- Основное рабочее пространство -->
            <div class="flex-1 flex flex-col overflow-hidden">
                <!-- График -->
                <div class="bg-white dark:bg-gray-800 p-4 border-b border-gray-200 dark:border-gray-700">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-semibold dark:text-gray-200">
                            <span v-if="selectedManagerSku">История цен для {{ selectedManagerSku.name }}</span>
                            <span v-else class="dark:text-gray-400">Выберите SKU менеджера для сравнения</span>
                        </h2>
                        <div class="flex space-x-2">
                            <select v-model="timeRange" class="border border-gray-300 rounded px-3 py-1 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                <option value="7">7 дней</option>
                                <option value="30">30 дней</option>
                                <option value="90">90 дней</option>
                            </select>
                            <button @click="toggleFullscreen" class="text-gray-500 hover:text-indigo-600 dark:text-gray-400 dark:hover:text-indigo-400">
                                <i class="fas fa-expand"></i>
                            </button>
                        </div>
                    </div>
                    <div class="h-64">
                        <canvas id="priceChart"></canvas>
                    </div>
                </div>

                <!-- Таблица сравнения с конкурентами -->
                <div class="flex-1 overflow-auto dark:bg-gray-800">
                    <div class="min-w-full">
                        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                            <thead class="bg-gray-50 dark:bg-gray-700 sticky top-0">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-300">
                                        Характеристика
                                    </th>
                                    <th v-if="selectedManagerSku" scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-300">
                                        <div class="flex items-center">
                                            <span class="manager-badge text-xs px-2 py-1 rounded mr-2">Ваш</span>
                                            {{ selectedManagerSku.name }}
                                        </div>
                                    </th>
                                    <th v-for="(competitor, index) in comparedCompetitors" :key="index" scope="col" 
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-300">
                                        <div class="flex items-center justify-between">
                                            <span>
                                                <span class="competitor-badge text-xs px-2 py-1 rounded mr-2">Конкурент</span>
                                                {{ competitor.name }}
                                            </span>
                                            <button @click="removeCompetitor(competitor)" class="text-gray-400 hover:text-red-500 dark:hover:text-red-400">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </div>
                                    </th>
                                    <th scope="col" class="px-6 py-3 text-center">
                                        <button @click="addCompetitor" 
                                                class="text-indigo-600 hover:text-indigo-800 dark:text-indigo-400 dark:hover:text-indigo-300 text-sm font-medium">
                                            <i class="fas fa-plus mr-1"></i> Добавить
                                        </button>
                                    </th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200 dark:bg-gray-800 dark:divide-gray-700">
                                <tr v-for="(row, rowIndex) in comparisonRows" :key="rowIndex" class="hover:bg-gray-50 dark:hover:bg-gray-700">
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-gray-200">
                                        {{ row.characteristic }}
                                    </td>
                                    <td v-if="selectedManagerSku" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-300">
                                        <div v-if="row.values.manager">
                                            {{ row.values.manager.value }}
                                            <span v-if="row.values.manager.trend === 'up'" 
                                                  class="price-increase ml-1"><i class="fas fa-arrow-up"></i></span>
                                            <span v-else-if="row.values.manager.trend === 'down'" 
                                                  class="price-decrease ml-1"><i class="fas fa-arrow-down"></i></span>
                                        </div>
                                        <div v-else class="text-gray-400">-</div>
                                    </td>
                                    <td v-for="(competitor, compIndex) in comparedCompetitors" :key="compIndex" 
                                        class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-300">
                                        <div v-if="row.values[competitor.id]">
                                            {{ row.values[competitor.id].value }}
                                            <span v-if="row.values[competitor.id].trend === 'up'" 
                                                  class="price-increase ml-1"><i class="fas fa-arrow-up"></i></span>
                                            <span v-else-if="row.values[competitor.id].trend === 'down'" 
                                                  class="price-decrease ml-1"><i class="fas fa-arrow-down"></i></span>
                                        </div>
                                        <div v-else class="text-gray-400">-</div>
                                    </td>
                                    <td></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>

        <!-- Футер -->
        <footer class="bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 py-4 px-6 text-center text-sm text-gray-500 dark:text-gray-400">
            <p>PriceMaster - Система сравнения цен • {{ new Date().getFullYear() }}</p>
        </footer>

        <!-- Модальное окно добавления менеджера -->
        <div v-if="showAddManagerModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-md">
                <div class="p-6">
                    <h3 class="text-lg font-medium text-gray-900 dark:text-gray-200 mb-4">
                        <i class="fas fa-user-plus mr-2"></i>Добавить менеджера
                    </h3>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Имя менеджера</label>
                        <input v-model="newManagerName" type="text" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Email</label>
                        <input v-model="newManagerEmail" type="email" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                    </div>
                    
                    <div class="flex justify-end space-x-3">
                        <button @click="showAddManagerModal = false" class="px-4 py-2 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">
                            Отмена
                        </button>
                        <button @click="addNewManager" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 dark:bg-indigo-700 dark:hover:bg-indigo-600">
                            Добавить
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Генерация случайных данных
        function generateSkuPriceHistory(sku) {
            const today = new Date();
            const history = [];
            let basePrice = Math.floor(Math.random() * 20000) + 5000;
            
            for (let i = 90; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(today.getDate() - i);
                
                const fluctuation = Math.random() > 0.7 ? (Math.random() * 0.1 - 0.05) * basePrice : 0;
                const price = Math.round(basePrice + fluctuation);
                
                history.push({
                    date: date.toISOString().split('T')[0],
                    price
                });
            }
            
            const currentPrice = history[history.length - 1].price;
            const monthAgoPrice = history[history.length - 30].price;
            sku.priceChange = parseFloat(((currentPrice - monthAgoPrice) / monthAgoPrice * 100).toFixed(1));
            
            return history;
        }
        
        function generateManagerSkus(count, prefix) {
            const skus = [];
            const products = [
                'Смартфон', 'Ноутбук', 'Наушники', 'Умные часы', 'Планшет', 
                'Фитнес-браслет', 'Игровая консоль', 'Электронная книга',
                'Монитор', 'Клавиатура', 'Мышь', 'Внешний жесткий диск'
            ];
            
            const brands = [
                'Samsung', 'Apple', 'Sony', 'Xiaomi', 'Huawei', 
                'Lenovo', 'Asus', 'Acer', 'Dell', 'HP'
            ];
            
            for (let i = 1; i <= count; i++) {
                const product = products[Math.floor(Math.random() * products.length)];
                const brand = brands[Math.floor(Math.random() * brands.length)];
                const sku = {
                    id: `${prefix}${i}`,
                    name: `${product} ${brand} ${Math.floor(Math.random() * 10) + 20}`,
                    priceHistory: [],
                    priceChange: 0
                };
                sku.priceHistory = generateSkuPriceHistory(sku);
                skus.push(sku);
            }
            
            return skus;
        }
        
        function generateCompetitorSkus(count) {
            return generateManagerSkus(count, 'comp');
        }
        
        // Основное приложение Vue
        new Vue({
            el: '#app',
            data: {
                currentUser: null,
                currentStoreId: null,
                currentManagerId: null,
                searchQuery: '',
                newSku: '',
                timeRange: '30',
                selectedManagerSku: null,
                comparedCompetitors: [],
                darkMode: false,
                chart: null,
                comparisonRows: [
                    { characteristic: 'Текущая цена', values: {} },
                    { characteristic: 'Минимальная цена (30 дн.)', values: {} },
                    { characteristic: 'Максимальная цена (30 дн.)', values: {} },
                    { characteristic: 'Средняя цена', values: {} },
                    { characteristic: 'Количество предложений', values: {} },
                    { characteristic: 'Рейтинг товара', values: {} },
                    { characteristic: 'Доступность', values: {} },
                    { characteristic: 'Доставка', values: {} },
                    { characteristic: 'Гарантия', values: {} }
                ],
                showAddManagerModal: false,
                newManagerName: '',
                newManagerEmail: '',
                competitorSkus: generateCompetitorSkus(20)
            },
            computed: {
                currentStore() {
                    if (!this.currentUser || !this.currentStoreId) return null;
                    return this.currentUser.stores.find(store => store.id === this.currentStoreId);
                },
                currentManager() {
                    if (!this.currentStore || !this.currentManagerId) return null;
                    return this.currentStore.managers.find(m => m.id === this.currentManagerId);
                },
                currentManagerSkus() {
                    if (!this.currentManager) return [];
                    return this.currentManager.skus;
                },
                filteredManagerSkus() {
                    if (!this.searchQuery) return this.currentManagerSkus;
                    const query = this.searchQuery.toLowerCase();
                    return this.currentManagerSkus.filter(sku => 
                        sku.name.toLowerCase().includes(query) || 
                        sku.id.toLowerCase().includes(query)
                    );
                }
            },
            watch: {
                currentManagerId() {
                    this.selectedManagerSku = null;
                },
                selectedManagerSku() {
                    this.updateChart();
                    this.updateComparisonTable();
                },
                comparedCompetitors() {
                    this.updateChart();
                    this.updateComparisonTable();
                },
                timeRange() {
                    this.updateChart();
                },
                darkMode() {
                    this.updateChart();
                }
            },
            mounted() {
                this.initializeUser();
                
                if (localStorage.getItem('darkMode')) {
                    this.darkMode = localStorage.getItem('darkMode') === 'true';
                } else {
                    this.darkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
                }
                
                this.applyTheme();
                
                this.$nextTick(() => {
                    this.initChart();
                });
            },
            methods: {
                initializeUser() {
                    this.currentUser = {
                        id: 'user1',
                        name: 'Иван Петров',
                        email: 'ivan.petrov@example.com',
                        stores: [
                            {
                                id: 'store1',
                                name: 'Электроника Онлайн',
                                managers: [
                                    {
                                        id: 'mgr1',
                                        name: 'Анна Сидорова',
                                        email: 'anna@example.com',
                                        skus: generateManagerSkus(8, 'mgr1')
                                    },
                                    {
                                        id: 'mgr2',
                                        name: 'Дмитрий Иванов',
                                        email: 'dmitry@example.com',
                                        skus: generateManagerSkus(6, 'mgr2')
                                    }
                                ]
                            },
                            {
                                id: 'store2',
                                name: 'Гаджеты Плюс',
                                managers: [
                                    {
                                        id: 'mgr3',
                                        name: 'Ольга Кузнецова',
                                        email: 'olga@example.com',
                                        skus: generateManagerSkus(7, 'mgr3')
                                    },
                                    {
                                        id: 'mgr4',
                                        name: 'Сергей Васильев',
                                        email: 'sergey@example.com',
                                        skus: generateManagerSkus(5, 'mgr4')
                                    }
                                ]
                            },
                            {
                                id: 'store3',
                                name: 'ТехноМаркет',
                                managers: [
                                    {
                                        id: 'mgr5',
                                        name: 'Мария Федорова',
                                        email: 'maria@example.com',
                                        skus: generateManagerSkus(9, 'mgr5')
                                    }
                                ]
                            }
                        ]
                    };
                    
                    if (this.currentUser.stores.length > 0) {
                        this.currentStoreId = this.currentUser.stores[0].id;
                        this.currentManagerId = this.currentUser.stores[0].managers[0].id;
                    }
                },
                applyTheme() {
                    if (this.darkMode) {
                        document.body.classList.add('dark');
                    } else {
                        document.body.classList.remove('dark');
                    }
                },
                toggleTheme() {
                    this.darkMode = !this.darkMode;
                    localStorage.setItem('darkMode', this.darkMode);
                    this.applyTheme();
                    this.updateChart();
                },
                changeStore() {
                    if (this.currentStore && this.currentStore.managers.length > 0) {
                        this.currentManagerId = this.currentStore.managers[0].id;
                    }
                    this.selectedManagerSku = null;
                },
                initChart() {
                    const canvasElement = document.getElementById('priceChart');
                    if (!canvasElement) {
                        console.warn('Canvas element not found. Skipping chart initialization.');
                        return;
                    }
                    
                    const ctx = canvasElement.getContext('2d');
                    this.chart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: [],
                            datasets: []
                        },
                        options: this.getChartOptions()
                    });
                },
                getChartOptions() {
                    const isDark = this.darkMode;
                    const textColor = isDark ? '#e5e7eb' : '#374151';
                    const gridColor = isDark ? 'rgba(55, 65, 81, 0.5)' : 'rgba(0, 0, 0, 0.05)';
                    
                    return {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: false,
                                grid: {
                                    color: gridColor
                                },
                                ticks: {
                                    color: textColor,
                                    callback: function(value) {
                                        return value.toLocaleString('ru-RU') + ' ₽';
                                    }
                                }
                            },
                            x: {
                                grid: {
                                    display: false
                                },
                                ticks: {
                                    color: textColor
                                }
                            }
                        },
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return context.dataset.label + ': ' + context.parsed.y.toLocaleString('ru-RU') + ' ₽';
                                    }
                                },
                                backgroundColor: isDark ? '#1f2937' : '#ffffff',
                                titleColor: isDark ? '#e5e7eb' : '#374151',
                                bodyColor: isDark ? '#e5e7eb' : '#374151',
                                borderColor: isDark ? '#374151' : '#e5e7eb'
                            },
                            legend: {
                                position: 'top',
                                labels: {
                                    boxWidth: 12,
                                    padding: 20,
                                    color: textColor
                                }
                            }
                        }
                    };
                },
                updateChart() {
                    if (!this.chart) return;
                    
                    const days = parseInt(this.timeRange);
                    const today = new Date();
                    const labels = [];
                    
                    for (let i = days - 1; i >= 0; i--) {
                        const date = new Date(today);
                        date.setDate(today.getDate() - i);
                        labels.push(date.toLocaleDateString('ru-RU', { day: 'numeric', month: 'short' }));
                    }
                    
                    const datasets = [];
                    const colors = [
                        '#4f46e5', // Индиго - ваш товар
                        '#ef4444', // Красный - конкурент 1
                        '#10b981', // Зеленый - конкурент 2
                        '#f59e0b', // Желтый - конкурент 3
                        '#8b5cf6', // Фиолетовый - конкурент 4
                        '#ec4899'  // Розовый - конкурент 5
                    ];
                    
                    if (this.selectedManagerSku) {
                        const prices = this.getPricesForPeriod(this.selectedManagerSku, days);
                        datasets.push({
                            label: `Ваш товар: ${this.selectedManagerSku.name}`,
                            data: prices,
                            borderColor: colors[0],
                            backgroundColor: this.darkMode ? 'rgba(79, 70, 229, 0.2)' : 'rgba(79, 70, 229, 0.1)',
                            borderWidth: 3,
                            tension: 0.2,
                            fill: false
                        });
                    }
                    
                    this.comparedCompetitors.forEach((competitor, index) => {
                        const prices = this.getPricesForPeriod(competitor, days);
                        datasets.push({
                            label: competitor.name,
                            data: prices,
                            borderColor: colors[(index + 1) % colors.length],
                            borderWidth: 2,
                            borderDash: [5, 5],
                            tension: 0.2,
                            fill: false
                        });
                    });
                    
                    this.chart.options = this.getChartOptions();
                    
                    this.chart.data.labels = labels;
                    this.chart.data.datasets = datasets;
                    this.chart.update();
                },
                getPricesForPeriod(sku, days) {
                    const startIndex = sku.priceHistory.length - days;
                    return sku.priceHistory.slice(startIndex).map(item => item.price);
                },
                selectManagerSku(sku) {
                    this.selectedManagerSku = sku;
                },
                addNewManagerSku() {
                    if (!this.newSku.trim() || !this.currentManager) return;
                    
                    const newId = 'sku' + Date.now();
                    const newSkuObj = {
                        id: newId,
                        name: this.newSku,
                        priceHistory: [],
                        priceChange: 0
                    };
                    
                    newSkuObj.priceHistory = generateSkuPriceHistory(newSkuObj);
                    
                    this.currentManager.skus.push(newSkuObj);
                    this.newSku = '';
                    
                    this.selectedManagerSku = newSkuObj;
                },
                addCompetitor() {
                    if (this.comparedCompetitors.length >= 5) {
                        alert('Максимум 5 конкурентов для сравнения');
                        return;
                    }
                    
                    const availableCompetitors = this.competitorSkus.filter(comp => 
                        !this.comparedCompetitors.some(c => c.id === comp.id)
                    );
                    
                    if (availableCompetitors.length > 0) {
                        const randomIndex = Math.floor(Math.random() * availableCompetitors.length);
                        this.comparedCompetitors.push(availableCompetitors[randomIndex]);
                    } else {
                        alert('Все доступные конкуренты уже добавлены');
                    }
                },
                removeCompetitor(competitor) {
                    this.comparedCompetitors = this.comparedCompetitors.filter(c => c.id !== competitor.id);
                },
                updateComparisonTable() {
                    this.comparisonRows.forEach(row => {
                        row.values = {};
                    });
                    
                    if (this.selectedManagerSku) {
                        const prices = this.getPricesForPeriod(this.selectedManagerSku, 30);
                        const minPrice = Math.min(...prices);
                        const maxPrice = Math.max(...prices);
                        const avgPrice = Math.round(prices.reduce((sum, price) => sum + price, 0) / prices.length);
                        const prevPrice = prices.length > 1 ? prices[prices.length - 2] : prices[0];
                        const currentPrice = prices[prices.length - 1];
                        const priceTrend = currentPrice > prevPrice ? 'up' : currentPrice < prevPrice ? 'down' : null;
                        
                        this.comparisonRows[0].values.manager = {
                            value: currentPrice.toLocaleString('ru-RU') + ' ₽',
                            trend: priceTrend
                        };
                        this.comparisonRows[1].values.manager = {
                            value: minPrice.toLocaleString('ru-RU') + ' ₽',
                            trend: null
                        };
                        this.comparisonRows[2].values.manager = {
                            value: maxPrice.toLocaleString('ru-RU') + ' ₽',
                            trend: null
                        };
                        this.comparisonRows[3].values.manager = {
                            value: avgPrice.toLocaleString('ru-RU') + ' ₽',
                            trend: null
                        };
                        this.comparisonRows[4].values.manager = {
                            value: Math.floor(Math.random() * 5) + 1,
                            trend: null
                        };
                        this.comparisonRows[5].values.manager = {
                            value: (Math.random() * 1 + 4).toFixed(1) + ' из 5',
                            trend: null
                        };
                        this.comparisonRows[6].values.manager = {
                            value: 'В наличии',
                            trend: null
                        };
                        this.comparisonRows[7].values.manager = {
                            value: '1-3 дня',
                            trend: null
                        };
                        this.comparisonRows[8].values.manager = {
                            value: '1 год',
                            trend: null
                        };
                    }
                    
                    this.comparedCompetitors.forEach(competitor => {
                        const prices = this.getPricesForPeriod(competitor, 30);
                        const minPrice = Math.min(...prices);
                        const maxPrice = Math.max(...prices);
                        const avgPrice = Math.round(prices.reduce((sum, price) => sum + price, 0) / prices.length);
                        const prevPrice = prices.length > 1 ? prices[prices.length - 2] : prices[0];
                        const currentPrice = prices[prices.length - 1];
                        const priceTrend = currentPrice > prevPrice ? 'up' : currentPrice < prevPrice ? 'down' : null;
                        
                        this.comparisonRows[0].values[competitor.id] = {
                            value: currentPrice.toLocaleString('ru-RU') + ' ₽',
                            trend: priceTrend
                        };
                        this.comparisonRows[1].values[competitor.id] = {
                            value: minPrice.toLocaleString('ru-RU') + ' ₽',
                            trend: null
                        };
                        this.comparisonRows[2].values[competitor.id] = {
                            value: maxPrice.toLocaleString('ru-RU') + ' ₽',
                            trend: null
                        };
                        this.comparisonRows[3].values[competitor.id] = {
                            value: avgPrice.toLocaleString('ru-RU') + ' ₽',
                            trend: null
                        };
                        this.comparisonRows[4].values[competitor.id] = {
                            value: Math.floor(Math.random() * 20) + 5,
                            trend: null
                        };
                        this.comparisonRows[5].values[competitor.id] = {
                            value: (Math.random() * 3 + 2).toFixed(1) + ' из 5',
                            trend: null
                        };
                        this.comparisonRows[6].values[competitor.id] = {
                            value: Math.random() > 0.2 ? 'В наличии' : 'Под заказ',
                            trend: null
                        };
                        this.comparisonRows[7].values[competitor.id] = {
                            value: Math.random() > 0.5 ? '1-3 дня' : '3-7 дней',
                            trend: null
                        };
                        this.comparisonRows[8].values[competitor.id] = {
                            value: Math.random() > 0.7 ? '2 года' : '1 год',
                            trend: null
                        };
                    });
                },
                addNewManager() {
                    if (!this.newManagerName.trim() || !this.currentStore) return;
                    
                    const newId = 'mgr' + Date.now();
                    const newManager = {
                        id: newId,
                        name: this.newManagerName,
                        email: this.newManagerEmail || `${newId}@example.com`,
                        skus: []
                    };
                    
                    this.currentStore.managers.push(newManager);
                    this.currentManagerId = newId;
                    this.showAddManagerModal = false;
                    this.newManagerName = '';
                    this.newManagerEmail = '';
                },
                toggleFullscreen() {
                    const chartContainer = document.querySelector('.chart-container');
                    if (!document.fullscreenElement) {
                        if (chartContainer.requestFullscreen) {
                            chartContainer.requestFullscreen();
                        }
                    } else {
                        if (document.exitFullscreen) {
                            document.exitFullscreen();
                        }
                    }
                }
            }
        });
    </script>
</body>
</html>
